/*
 * noVNC: HTML5 VNC client
 * Copyright (C) 2012 Joel Martin
 * Copyright (C) 2013 Samuel Mannehed for Cendio AB
 * Licensed under MPL 2.0 (see LICENSE.txt)
 *
 * See README.md for usage and integration instructions.
 *
 * TIGHT decoder portion:
 * (c) 2012 Michael Tinglof, Joe Balaz, Les Piech (Mercuri.ca)
 */
function RFB(t){"use strict";function e(){var t,e;for(Util.Debug(">> RFB.constructor"),t=0;t<F.length;t+=1)W[F[t][1]]=W[F[t][0]],B[F[t][1]]=F[t][0],O[F[t][1]]=[0,0];try{L=new Display({target:E.target})}catch(n){Util.Error("Display exception: "+n),s("fatal","No working Display")}return q=new Keyboard({target:E.focusContainer,onKeyPress:k}),H=new Mouse({target:E.target,onMouseButton:C,onMouseMove:T,notify:q.sync}),e=L.get_render_mode(),P=new Websock,P.on("message",l),P.on("open",function(){"connect"===A?s("ProtocolVersion","Starting VNC handshake"):a("Got unexpected WebSockets connection")}),P.on("close",function(t){Util.Warn("WebSocket on-close event");var e="";t.code&&(e=" (code: "+t.code,t.reason&&(e+=", reason: "+t.reason),e+=")"),"disconnect"===A?s("disconnected","VNC disconnected"+e):"ProtocolVersion"===A?a("Failed to connect to server"+e):A in{failed:1,disconnected:1}?Util.Error("Received onclose while disconnected"+e):a("Server disconnected"+e)}),P.on("error",function(){Util.Warn("WebSocket on-error event")}),o(),Websock_native?(Util.Info("Using native WebSockets"),s("loaded","noVNC ready: native WebSockets, "+e)):(Util.Warn("Using web-socket-js bridge. Flash version: "+Util.Flash.version),!Util.Flash||Util.Flash.version<9?s("fatal","WebSockets or <a href='http://get.adobe.com/flashplayer'>Adobe Flash</a> is required"):"file://"===document.location.href.substr(0,7)?s("fatal","'file://' URL is incompatible with Adobe Flash"):s("loaded","noVNC ready: WebSockets emulation, "+e)),Util.Debug("<< RFB.constructor"),S}function n(){Util.Debug(">> RFB.connect");var t;t="undefined"!=typeof UsingSocketIO?"http":E.encrypt?"wss":"ws",t+="://"+U+":"+D+"/"+I,Util.Info("connecting to "+t),P.open(t,E.wsProtocols),Util.Debug("<< RFB.connect")}function r(t,e){var n,r=[];for(n=0;n<t.length;n+=1)r.push(t.charCodeAt(n));return new DES(r).encrypt(e)}function i(t){1===Y&&a("Tight protocol handler only implements true color mode");var e,n,r,i,o,s,l=-1,u=0,c=-1,f=P.get_rQ(),d=P.get_rQi();if(X.bytes=1,P.rQwait("TIGHT compression-control",X.bytes))return!1;var h=function(t){for(var e=0;4>e;e++)u>>e&1&&(X.zlibs[e].reset(),Util.Info("Reset zlib stream "+e));var n=X.zlibs[c].uncompress(t,0);return 0!==n.status&&Util.Error("Invalid data in zlib stream"),n.data},p=function(t,e,n,r,i){var o,s,a,l,u,c,f,d=[];if(2===e)for(l=Math.floor((r+7)/8),u=Math.floor(r/8),s=0;i>s;s++){for(o=0;u>o;o++)for(a=7;a>=0;a--)c=3*(s*r+8*o+7-a),f=3*(t[s*l+o]>>a&1),d[c]=n[f],d[c+1]=n[f+1],d[c+2]=n[f+2];for(a=7;a>=8-r%8;a--)c=3*(s*r+8*o+7-a),f=3*(t[s*l+o]>>a&1),d[c]=n[f],d[c+1]=n[f+1],d[c+2]=n[f+2]}else for(s=0;i>s;s++)for(o=0;r>o;o++)c=3*(s*r+o),f=3*t[s*r+o],d[c]=n[f],d[c+1]=n[f+1],d[c+2]=n[f+2];return d},g=function(){var t=f[d+2]+1,e=t*Y;if(X.bytes+=e,P.rQwait("TIGHT palette "+n,X.bytes))return!1;var i=2>=t?1:8,o=Math.floor((X.width*i+7)/8),a=!1;if(o*X.height<12?(a=!0,r=[0,o*X.height]):r=w(P.rQslice(3+e,3+e+3)),X.bytes+=r[0]+r[1],P.rQwait("TIGHT "+n,X.bytes))return!1;P.rQshiftBytes(3);var l=P.rQshiftBytes(e);P.rQshiftBytes(r[0]),s=a?P.rQshiftBytes(r[1]):h(P.rQshiftBytes(r[1]));var u=p(s,t,l,X.width,X.height);return L.renderQ_push({type:"blitRgb",data:u,x:X.x,y:X.y,width:X.width,height:X.height}),!0},m=function(){var t=!1,e=X.width*X.height*Y;return 12>e?(t=!0,r=[0,e]):r=w(P.rQslice(1,4)),X.bytes=1+r[0]+r[1],P.rQwait("TIGHT "+n,X.bytes)?!1:(P.rQshiftBytes(1+r[0]),s=t?P.rQshiftBytes(r[1]):h(P.rQshiftBytes(r[1])),L.renderQ_push({type:"blitRgb",data:s,x:X.x,y:X.y,width:X.width,height:X.height}),!0)};if(e=P.rQpeek8(),u=15&e,e>>=4,c=3&e,8===e)n="fill";else if(9===e)n="jpeg";else if(10===e)n="png";else if(4&e)n="filter";else{if(!(4>e))return a("Illegal tight compression received, ctl: "+e);n="copy"}if(t&&("filter"===n||"copy"===n))return a("filter/copy received in tightPNG mode");switch(n){case"fill":X.bytes+=Y;break;case"jpeg":X.bytes+=3;break;case"png":X.bytes+=3;break;case"filter":X.bytes+=2;break;case"copy":}if(P.rQwait("TIGHT "+n,X.bytes))return!1;switch(n){case"fill":P.rQshift8(),i=P.rQshiftBytes(Y),L.renderQ_push({type:"fill",x:X.x,y:X.y,width:X.width,height:X.height,color:[i[2],i[1],i[0]]});break;case"png":case"jpeg":if(r=w(P.rQslice(1,4)),X.bytes=1+r[0]+r[1],P.rQwait("TIGHT "+n,X.bytes))return!1;P.rQshiftBytes(1+r[0]),o=new Image,o.src="data:image/"+n+x(P.rQshiftBytes(r[1])),L.renderQ_push({type:"img",img:o,x:X.x,y:X.y}),o=null;break;case"filter":if(l=f[d+1],1!==l)throw"Unsupported tight subencoding received, filter: "+l;if(!g())return!1;break;case"copy":if(!m())return!1}return X.bytes=0,X.rects-=1,!0}var o,s,a,l,u,c,f,d,h,p,g,m,y,v,b,w,x,k,C,T,_,S={},E={},U="",D=5900,$="",I="",A="disconnected",j=0,N=3.8,Q="",R=!1,M=0,F=[["COPYRECT",1],["TIGHT",7],["TIGHT_PNG",-260],["HEXTILE",5],["RRE",2],["RAW",0],["DesktopSize",-223],["Cursor",-239],["JPEG_quality_med",-26],["compress_hi",-247],["last_rect",-224],["xvp",-309]],W={},B={},O={},P=null,L=null,q=null,H=null,z=null,V=null,K=null,X={rects:0,subrects:0,lines:0,tiles:0,bytes:0,x:0,y:0,width:0,height:0,encoding:0,subencoding:-1,background:null,zlibs:[]},G=4,Y=3,J=0,Z=0,te="",ee=100,ne={last_fbu:0,fbu_total:0,fbu_total_cnt:0,full_fbu_total:0,full_fbu_cnt:0,fbu_rt_start:0,fbu_rt_total:0,fbu_rt_cnt:0,pixels:0},re=!1,ie=0,oe=[],se=!1,ae={};return Util.conf_defaults(E,S,t,[["target","wo","dom",null,"VNC display rendering Canvas object"],["focusContainer","wo","dom",document,"DOM element that captures keyboard input"],["encrypt","rw","bool",!1,"Use TLS/SSL/wss encryption"],["true_color","rw","bool",!0,"Request true color pixel data"],["local_cursor","rw","bool",!1,"Request locally rendered cursor"],["shared","rw","bool",!0,"Request shared mode"],["view_only","rw","bool",!1,"Disable client mouse/keyboard"],["xvp_password_sep","rw","str","@","Separator for XVP password fields"],["disconnectTimeout","rw","int",3,"Time (s) to wait for disconnection"],["wsProtocols","rw","arr",["binary","base64"],"Protocols to use in the WebSocket connection"],["repeaterID","rw","str","","RepeaterID to connect to"],["viewportDrag","rw","bool",!1,"Move the viewport on mouse drags"],["onUpdateState","rw","func",function(){},"onUpdateState(rfb, state, oldstate, statusMsg): RFB state update/change "],["onPasswordRequired","rw","func",function(){},"onPasswordRequired(rfb): VNC password is required "],["onClipboard","rw","func",function(){},"onClipboard(rfb, text): RFB clipboard contents received"],["onBell","rw","func",function(){},"onBell(rfb): RFB Bell message received "],["onFBUReceive","rw","func",function(){},"onFBUReceive(rfb, fbu): RFB FBU received but not yet processed "],["onFBUComplete","rw","func",function(){},"onFBUComplete(rfb, fbu): RFB FBU received and processed "],["onFBResize","rw","func",function(){},"onFBResize(rfb, width, height): frame buffer resized"],["onDesktopName","rw","func",function(){},"onDesktopName(rfb, name): desktop name received"],["onXvpInit","rw","func",function(){},"onXvpInit(version): XVP extensions active for this connection"],["updateState","rw","func",function(){},"obsolete, use onUpdateState"],["clipboardReceive","rw","func",function(){},"obsolete, use onClipboard"]]),S.set_local_cursor=function(t){!t||t in{0:1,no:1,"false":1}?E.local_cursor=!1:L.get_cursor_uri()?E.local_cursor=!0:Util.Warn("Browser does not support local cursor")},S.get_display=function(){return L},S.get_keyboard=function(){return q},S.get_mouse=function(){return H},o=function(){var t;for(P.init(),X.rects=0,X.subrects=0,X.lines=0,X.tiles=0,X.zlibs=[],ie=0,oe=[],t=0;t<F.length;t+=1)O[F[t][1]][0]=0;for(t=0;4>t;t++)X.zlibs[t]=new TINF,X.zlibs[t].init()},d=function(){var t,e;for(Util.Info("Encoding stats for this connection:"),t=0;t<F.length;t+=1)e=O[F[t][1]],e[0]+e[1]>0&&Util.Info("    "+F[t][0]+": "+e[0]+" rects");for(Util.Info("Encoding stats since page load:"),t=0;t<F.length;t+=1)e=O[F[t][1]],e[0]+e[1]>0&&Util.Info("    "+F[t][0]+": "+e[1]+" rects")},s=function(t,e){var r,i,l=A;if(t===l)return void Util.Debug("Already in state '"+t+"', ignoring.");switch(t in{disconnected:1,loaded:1,connect:1,disconnect:1,failed:1,fatal:1}&&(z&&(clearInterval(z),z=null),K&&(clearTimeout(K),K=null),L&&L.get_context()&&(q.ungrab(),H.ungrab(),L.defaultCursor(),("debug"!==Util.get_logging()||"loaded"===t)&&L.clear()),P.close()),"fatal"===l&&Util.Error("Fatal error, cannot continue"),r="failed"===t||"fatal"===t?Util.Error:Util.Warn,i="undefined"!=typeof e?" Msg: "+e:"",r("New state '"+t+"', was '"+l+"'."+i),A="failed"===l&&"disconnected"===t?"failed":t,V&&"disconnect"!==A&&(Util.Debug("Clearing disconnect timer"),clearTimeout(V),V=null),t){case"normal":("disconnected"===l||"failed"===l)&&Util.Error("Invalid transition from 'disconnected' or 'failed' to 'normal'");break;case"connect":o(),n();break;case"disconnect":re||(V=setTimeout(function(){a("Disconnect timeout")},1e3*E.disconnectTimeout)),d();break;case"failed":"disconnected"===l&&Util.Error("Invalid transition from 'disconnected' to 'failed'"),"normal"===l&&Util.Error("Error while connected."),"init"===l&&Util.Error("Error while initializing."),setTimeout(function(){s("disconnected")},50)}"failed"===l&&"disconnected"===t?(E.updateState(S,t,l),E.onUpdateState(S,t,l)):(E.updateState(S,t,l,e),E.onUpdateState(S,t,l,e))},a=function(t){return s("failed",t),!1},l=function(){if(0===P.rQlen())return void Util.Warn("handle_message called on empty receive queue");switch(A){case"disconnected":case"failed":Util.Error("Got data while disconnected");break;case"normal":c()&&P.rQlen()>0&&(null===K?(Util.Debug("More data to process, creating timer"),K=setTimeout(function(){K=null,l()},10)):Util.Debug("More data to process, existing timer"));break;default:u()}},_=function(){"normal"===A&&!se&&oe.length>0&&(P.send(oe),oe=[])},k=function(t,e){E.view_only||P.send(y(t,e))},C=function(t,e,n,r){if(n?ie|=r:ie^=r,E.viewportDrag){if(n&&!se)return se=!0,void(ae={x:t,y:e});se=!1}E.view_only||(oe=oe.concat(v(L.absX(t),L.absY(e))),P.send(oe),oe=[])},T=function(t,e){var n,r;return se?(n=ae.x-t,r=ae.y-e,ae={x:t,y:e},void L.viewportChange(n,r)):void(E.view_only||(oe=oe.concat(v(L.absX(t),L.absY(e))),_()))},u=function(){var t,e,n,i,o,l,c,f,d,g,y,v,b,w,x,k,C,T,U,D,I,M,F,W,B,O;switch(A){case"ProtocolVersion":if(P.rQlen()<12)return a("Incomplete protocol version");switch(i=P.rQshiftStr(12).substr(4,7),Util.Info("Server ProtocolVersion: "+i),F=0,i){case"000.000":F=1;break;case"003.003":j=3.3;break;case"003.006":j=3.3;break;case"003.889":j=3.3;break;case"003.007":j=3.7;break;case"003.008":j=3.8;break;case"004.000":j=3.8;break;case"004.001":j=3.8;break;default:return a("Invalid server version "+i)}if(F){for(l=E.repeaterID;l.length<250;)l+="\x00";P.send_string(l);break}j>N&&(j=N),re||(z=setInterval(function(){P.flush()},50)),o="00"+parseInt(j,10)+".00"+10*j%10,P.send_string("RFB "+o+"\n"),s("Security","Sent ProtocolVersion: "+o);break;case"Security":if(j>=3.7){if(d=P.rQshift8(),P.rQwait("security type",d,1))return!1;if(0===d)return t=P.rQshift32(),e=P.rQshiftStr(t),a("Security failure: "+e);for(Q=0,f=P.rQshiftBytes(d),Util.Debug("Server security types: "+f),c=0;c<f.length;c+=1)f[c]>Q&&(f[c]<=16||22==f[c])&&(Q=f[c]);if(0===Q)return a("Unsupported security types: "+f);P.send([Q])}else{if(P.rQwait("security scheme",4))return!1;Q=P.rQshift32()}s("Authentication","Authenticating using scheme: "+Q),u();break;case"Authentication":switch(Q){case 0:return P.rQwait("auth reason",4)?!1:(t=P.rQshift32(),e=P.rQshiftStr(t),a("Auth failure: "+e));case 1:if(j>=3.8)return void s("SecurityResult");break;case 22:if(W=E.xvp_password_sep,B=$.split(W),B.length<3)return s("password","XVP credentials required (user"+W+"target"+W+"password) -- got only "+$),void E.onPasswordRequired(S);O=String.fromCharCode(B[0].length)+String.fromCharCode(B[1].length)+B[0]+B[1],P.send_string(O),$=B.slice(2).join(W),Q=2;case 2:return 0===$.length?(s("password","Password Required"),void E.onPasswordRequired(S)):P.rQwait("auth challenge",16)?!1:(g=P.rQshiftBytes(16),y=r($,g),P.send(y),void s("SecurityResult"));case 16:if(P.rQwait("num tunnels",4))return!1;var V=P.rQshift32();if(R=!0,0!=V)return void a("Protocol requested tunnels, not currently supported. numTunnels: "+V);var K={STDVNOAUTH__:1,STDVVNCAUTH_:2},X=[];if(P.rQwait("sub auth count",4))return!1;for(var ee=P.rQshift32(),c=0;ee>c;c++){if(P.rQwait("sub auth capabilities "+c,16))return!1;var ie=(P.rQshift32(),P.rQshiftStr(12));X.push(ie)}for(var oe in K)if(-1!=X.indexOf(oe))switch(P.send([0,0,0,K[oe]]),oe){case"STDVNOAUTH__":return void s("SecurityResult");case"STDVVNCAUTH_":return Q=2,void u();default:return void a("Unsupported tiny auth scheme: "+oe)}return;default:return void a("Unsupported auth scheme: "+Q)}s("ClientInitialisation","No auth required"),u();break;case"SecurityResult":if(P.rQwait("VNC auth response ",4))return!1;switch(P.rQshift32()){case 0:break;case 1:if(j>=3.8){if(n=P.rQshift32(),P.rQwait("SecurityResult reason",n,8))return!1;e=P.rQshiftStr(n),a(e)}else a("Authentication failed");return;case 2:return a("Too many auth attempts")}s("ClientInitialisation","Authentication OK"),u();break;case"ClientInitialisation":P.send([E.shared?1:0]),s("ServerInitialisation","Authentication OK");break;case"ServerInitialisation":if(P.rQwait("server initialization",24))return!1;if(J=P.rQshift16(),Z=P.rQshift16(),v=P.rQshift8(),b=P.rQshift8(),w=P.rQshift8(),I=P.rQshift8(),x=P.rQshift16(),k=P.rQshift16(),C=P.rQshift16(),T=P.rQshift8(),U=P.rQshift8(),D=P.rQshift8(),P.rQshiftStr(3),Util.Info("Screen: "+J+"x"+Z+", bpp: "+v+", depth: "+b+", big_endian: "+w+", true_color: "+I+", red_max: "+x+", green_max: "+k+", blue_max: "+C+", red_shift: "+T+", green_shift: "+U+", blue_shift: "+D),0!==w&&Util.Warn("Server native endian is not little endian"),16!==T&&Util.Warn("Server native red-shift is not 16"),0!==D&&Util.Warn("Server native blue-shift is not 0"),M=P.rQshift32(),te=Util.decodeUTF8(P.rQshiftStr(M)),E.onDesktopName(S,te),E.true_color&&"Intel(r) AMT KVM"===te&&(Util.Warn("Intel AMT KVM only support 8/16 bit depths. Disabling true color"),E.true_color=!1),R){var se=P.rQshift16(),ae=P.rQshift16(),le=P.rQshift16();P.rQshift16();for(var c=0;se>c;c++){P.rQshiftStr(16)}for(var c=0;ae>c;c++){P.rQshiftStr(16)}for(var c=0;le>c;c++){P.rQshiftStr(16)}}L.set_true_color(E.true_color),E.onFBResize(S,J,Z),L.resize(J,Z),q.grab(),H.grab(),E.true_color?(G=4,Y=3):(G=1,Y=1),y=h(),y=y.concat(p()),y=y.concat(m()),ne.fbu_rt_start=(new Date).getTime(),ne.pixels=0,P.send(y),_(),E.encrypt?s("normal","Connected (encrypted) to: "+te):s("normal","Connected (unencrypted) to: "+te)}},c=function(){var t,e,n,r,i,o,l,u,c,d,h,p=!0;switch(t=X.rects>0?0:P.rQshift8()){case 0:p=f(),p&&P.send(m());break;case 1:if(Util.Debug("SetColourMapEntries"),P.rQshift8(),i=P.rQshift16(),o=P.rQshift16(),P.rQwait("SetColourMapEntries",6*o,6))return!1;for(r=0;o>r;r+=1)l=P.rQshift16(),l=parseInt(l/256,10),u=parseInt(P.rQshift16()/256,10),c=parseInt(P.rQshift16()/256,10),L.set_colourMap([c,u,l],i+r);Util.Debug("colourMap: "+L.get_colourMap()),Util.Info("Registered "+o+" colourMap entries");break;case 2:Util.Debug("Bell"),E.onBell(S);break;case 3:if(Util.Debug("ServerCutText"),P.rQwait("ServerCutText header",7,1))return!1;if(P.rQshiftBytes(3),e=P.rQshift32(),P.rQwait("ServerCutText",e,8))return!1;n=P.rQshiftStr(e),E.clipboardReceive(S,n),E.onClipboard(S,n);break;case 250:switch(P.rQshift8(),d=P.rQshift8(),h=P.rQshift8()){case 0:s(A,"Operation failed");break;case 1:M=d,Util.Info("XVP extensions enabled (version "+M+")"),E.onXvpInit(M);break;default:a("Disconnected: illegal server XVP message "+h)}break;default:a("Disconnected: illegal server message type "+t),Util.Debug("ws.rQslice(0,30):"+P.rQslice(0,30))}return p},f=function(){var t,e,n,r=!0;if(0===X.rects){if(P.rQwait("FBU header",3))return P.rQunshift8(0),!1;P.rQshift8(),X.rects=P.rQshift16(),X.bytes=0,ne.cur_fbu=0,ne.fbu_rt_start>0&&(t=(new Date).getTime(),Util.Info("First FBU latency: "+(t-ne.fbu_rt_start)))}for(;X.rects>0;){if("normal"!==A)return!1;if(P.rQwait("FBU",X.bytes))return!1;if(0===X.bytes){if(P.rQwait("rect header",12))return!1;if(e=P.rQshiftBytes(12),X.x=(e[0]<<8)+e[1],X.y=(e[2]<<8)+e[3],X.width=(e[4]<<8)+e[5],X.height=(e[6]<<8)+e[7],X.encoding=parseInt((e[8]<<24)+(e[9]<<16)+(e[10]<<8)+e[11],10),E.onFBUReceive(S,{x:X.x,y:X.y,width:X.width,height:X.height,encoding:X.encoding,encodingName:B[X.encoding]}),!B[X.encoding])return a("Disconnected: unsupported encoding "+X.encoding),!1}if(ne.last_fbu=(new Date).getTime(),r=W[X.encoding](),t=(new Date).getTime(),ne.cur_fbu+=t-ne.last_fbu,r&&(O[X.encoding][0]+=1,O[X.encoding][1]+=1,ne.pixels+=X.width*X.height),ne.pixels>=J*Z&&((X.width===J&&X.height===Z||ne.fbu_rt_start>0)&&(ne.full_fbu_total+=ne.cur_fbu,ne.full_fbu_cnt+=1,Util.Info("Timing of full FBU, cur: "+ne.cur_fbu+", total: "+ne.full_fbu_total+", cnt: "+ne.full_fbu_cnt+", avg: "+ne.full_fbu_total/ne.full_fbu_cnt)),ne.fbu_rt_start>0&&(n=t-ne.fbu_rt_start,ne.fbu_rt_total+=n,ne.fbu_rt_cnt+=1,Util.Info("full FBU round-trip, cur: "+n+", total: "+ne.fbu_rt_total+", cnt: "+ne.fbu_rt_cnt+", avg: "+ne.fbu_rt_total/ne.fbu_rt_cnt),ne.fbu_rt_start=0)),!r)return r}return E.onFBUComplete(S,{x:X.x,y:X.y,width:X.width,height:X.height,encoding:X.encoding,encodingName:B[X.encoding]}),!0},W.RAW=function(){var t,e;return 0===X.lines&&(X.lines=X.height),X.bytes=X.width*G,P.rQwait("RAW",X.bytes)?!1:(t=X.y+(X.height-X.lines),e=Math.min(X.lines,Math.floor(P.rQlen()/(X.width*G))),L.blitImage(X.x,t,X.width,e,P.get_rQ(),P.get_rQi()),P.rQshiftBytes(X.width*e*G),X.lines-=e,X.lines>0?X.bytes=X.width*G:(X.rects-=1,X.bytes=0),!0)},W.COPYRECT=function(){return X.bytes=4,P.rQwait("COPYRECT",4)?!1:(L.renderQ_push({type:"copy",old_x:P.rQshift16(),old_y:P.rQshift16(),x:X.x,y:X.y,width:X.width,height:X.height}),X.rects-=1,X.bytes=0,!0)},W.RRE=function(){var t,e,n,r,i,o;if(0===X.subrects){if(X.bytes=4+G,P.rQwait("RRE",4+G))return!1;X.subrects=P.rQshift32(),t=P.rQshiftBytes(G),L.fillRect(X.x,X.y,X.width,X.height,t)}for(;X.subrects>0&&P.rQlen()>=G+8;)t=P.rQshiftBytes(G),e=P.rQshift16(),n=P.rQshift16(),r=P.rQshift16(),i=P.rQshift16(),L.fillRect(X.x+e,X.y+n,r,i,t),X.subrects-=1;return X.subrects>0?(o=Math.min(ee,X.subrects),X.bytes=(G+8)*o):(X.rects-=1,X.bytes=0),!0},W.HEXTILE=function(){var t,e,n,r,i,o,s,l,u,c,f,d,h,p,g,m,y,v=P.get_rQ(),b=P.get_rQi();for(0===X.tiles&&(X.tiles_x=Math.ceil(X.width/16),X.tiles_y=Math.ceil(X.height/16),X.total_tiles=X.tiles_x*X.tiles_y,X.tiles=X.total_tiles);X.tiles>0;){if(X.bytes=1,P.rQwait("HEXTILE subencoding",X.bytes))return!1;if(t=v[b],t>30)return a("Disconnected: illegal hextile subencoding "+t),!1;if(e=0,r=X.total_tiles-X.tiles,i=r%X.tiles_x,l=Math.floor(r/X.tiles_x),o=X.x+16*i,u=X.y+16*l,s=Math.min(16,X.x+X.width-o),c=Math.min(16,X.y+X.height-u),1&t)X.bytes+=s*c*G;else if(2&t&&(X.bytes+=G),4&t&&(X.bytes+=G),8&t){if(X.bytes+=1,P.rQwait("hextile subrects header",X.bytes))return!1;e=v[b+X.bytes-1],X.bytes+=16&t?e*(G+2):2*e}if(P.rQwait("hextile",X.bytes))return!1;if(X.subencoding=v[b],b+=1,0===X.subencoding)1&X.lastsubencoding?Util.Debug("     Ignoring blank after RAW"):L.fillRect(o,u,s,c,X.background);else if(1&X.subencoding)L.blitImage(o,u,s,c,v,b),b+=X.bytes-1;else{if(2&X.subencoding&&(X.background=v.slice(b,b+G),b+=G),4&X.subencoding&&(X.foreground=v.slice(b,b+G),b+=G),L.startTile(o,u,s,c,X.background),8&X.subencoding)for(e=v[b],b+=1,d=0;e>d;d+=1)16&X.subencoding?(n=v.slice(b,b+G),b+=G):n=X.foreground,f=v[b],b+=1,h=f>>4,p=15&f,g=v[b],b+=1,m=(g>>4)+1,y=(15&g)+1,L.subTile(h,p,m,y,n);L.finishTile()}P.set_rQi(b),X.lastsubencoding=X.subencoding,X.bytes=0,X.tiles-=1}return 0===X.tiles&&(X.rects-=1),!0},w=function(t){var e=1,n=0;return n+=127&t[0],128&t[0]&&(e+=1,n+=(127&t[1])<<7,128&t[1]&&(e+=1,n+=t[2]<<14)),[e,n]},x=function(t){return";base64,"+Base64.encode(t)},W.TIGHT=function(){return i(!1)},W.TIGHT_PNG=function(){return i(!0)},W.last_rect=function(){return X.rects=0,!0},W.DesktopSize=function(){return Util.Debug(">> set_desktopsize"),J=X.width,Z=X.height,E.onFBResize(S,J,Z),L.resize(J,Z),ne.fbu_rt_start=(new Date).getTime(),X.bytes=0,X.rects-=1,Util.Debug("<< set_desktopsize"),!0},W.Cursor=function(){var t,e,n,r,i,o;return Util.Debug(">> set_cursor"),t=X.x,e=X.y,n=X.width,r=X.height,i=n*r*G,o=Math.floor((n+7)/8)*r,X.bytes=i+o,P.rQwait("cursor encoding",X.bytes)?!1:(L.changeCursor(P.rQshiftBytes(i),P.rQshiftBytes(o),t,e,n,r),X.bytes=0,X.rects-=1,Util.Debug("<< set_cursor"),!0)},W.JPEG_quality_lo=function(){Util.Error("Server sent jpeg_quality pseudo-encoding")},W.compress_lo=function(){Util.Error("Server sent compress level pseudo-encoding")},h=function(){var t;return t=[0],t.push8(0),t.push8(0),t.push8(0),t.push8(8*G),t.push8(8*Y),t.push8(0),t.push8(E.true_color?1:0),t.push16(255),t.push16(255),t.push16(255),t.push8(16),t.push8(8),t.push8(0),t.push8(0),t.push8(0),t.push8(0),t},p=function(){var t,e,n=[];for(e=0;e<F.length;e+=1)"Cursor"!==F[e][0]||E.local_cursor?"TIGHT"!==F[e][0]||E.true_color?n.push(F[e][1]):Util.Warn("Skipping tight, only support with true color"):Util.Debug("Skipping Cursor pseudo-encoding");for(t=[2],t.push8(0),t.push16(n.length),e=0;e<n.length;e+=1)t.push32(n[e]);return t},g=function(t,e,n,r,i){"undefined"==typeof e&&(e=0),"undefined"==typeof n&&(n=0),"undefined"==typeof r&&(r=J),"undefined"==typeof i&&(i=Z);var o;return o=[3],o.push8(t),o.push16(e),o.push16(n),o.push16(r),o.push16(i),o},m=function(){var t,e,n,r=L.getCleanDirtyReset(),i=[];for(e=r.cleanBox,e.w>0&&e.h>0&&(i=i.concat(g(1,e.x,e.y,e.w,e.h))),t=0;t<r.dirtyBoxes.length;t++)n=r.dirtyBoxes[t],i=i.concat(g(0,n.x,n.y,n.w,n.h));return i},y=function(t,e){var n;return n=[4],n.push8(e),n.push16(0),n.push32(t),n},v=function(t,e){var n;return n=[5],n.push8(ie),n.push16(t),n.push16(e),n},b=function(t){var e,n,r;for(e=[6],e.push8(0),e.push8(0),e.push8(0),e.push32(t.length),r=t.length,n=0;r>n;n+=1)e.push(t.charCodeAt(n));return e},S.connect=function(t,e,n,r){return U=t,D=e,$=void 0!==n?n:"",I=void 0!==r?r:"",U&&D?void s("connect"):a("Must set host and port")},S.disconnect=function(){s("disconnect","Disconnecting")},S.sendPassword=function(t){$=t,A="Authentication",setTimeout(u,1)},S.sendCtrlAltDel=function(){if("normal"!==A||E.view_only)return!1;Util.Info("Sending Ctrl-Alt-Del");var t=[];t=t.concat(y(65507,1)),t=t.concat(y(65513,1)),t=t.concat(y(65535,1)),t=t.concat(y(65535,0)),t=t.concat(y(65513,0)),t=t.concat(y(65507,0)),P.send(t)},S.xvpOp=function(t,e){return t>M?!1:(Util.Info("Sending XVP operation "+e+" (version "+t+")"),P.send_string("\xfa\x00"+String.fromCharCode(t)+String.fromCharCode(e)),!0)},S.xvpShutdown=function(){return S.xvpOp(1,2)},S.xvpReboot=function(){return S.xvpOp(1,3)},S.xvpReset=function(){return S.xvpOp(1,4)},S.sendKey=function(t,e){if("normal"!==A||E.view_only)return!1;var n=[];"undefined"!=typeof e?(Util.Info("Sending key code ("+(e?"down":"up")+"): "+t),n=n.concat(y(t,e?1:0))):(Util.Info("Sending key code (down + up): "+t),n=n.concat(y(t,1)),n=n.concat(y(t,0))),P.send(n)},S.clipboardPasteFrom=function(t){"normal"===A&&P.send(b(t))},S.testMode=function(t,e){re=!0,S.recv_message=P.testMode(t,e),_=function(){},S.connect=function(t,e,n){U=t,D=e,$=n,o(),s("ProtocolVersion","Starting VNC handshake")}},e()}