/*
 * noVNC: HTML5 VNC client
 * Copyright (C) 2012 Joel Martin
 * Copyright (C) 2013 Samuel Mannehed for Cendio AB
 * Licensed under MPL 2.0 or any later version (see LICENSE.txt)
 */
function Keyboard(e){"use strict";function t(e){a.onKeyPress&&(Util.Debug("onKeyPress "+("keydown"==e.type?"down":"up")+", keysym: "+e.keysym.keysym+"("+e.keysym.keyname+")"),a.onKeyPress(e.keysym.keysym,"keydown"==e.type))}function n(e){return a.focused&&l.keydown(e)?(Util.stopEvent(e),!1):!0}function r(e){return a.focused&&l.keypress(e)?(Util.stopEvent(e),!1):!0}function i(e){return a.focused&&l.keyup(e)?(Util.stopEvent(e),!1):!0}function o(){Util.Debug(">> Keyboard.allKeysUp"),l.releaseAll(),Util.Debug("<< Keyboard.allKeysUp")}var s={},a={};Util.conf_defaults(a,s,e,[["target","wo","dom",document,"DOM element that captures keyboard input"],["focused","rw","bool",!0,"Capture and send key events"],["onKeyPress","rw","func",null,"Handler for key press/release"]]);var l=KeyEventDecoder(kbdUtil.ModifierSync(),VerifyCharModifier(TrackKeyState(EscapeModifiers(t))));return s.grab=function(){var e=a.target;Util.addEvent(e,"keydown",n),Util.addEvent(e,"keyup",i),Util.addEvent(e,"keypress",r),Util.addEvent(window,"blur",o)},s.ungrab=function(){var e=a.target;Util.removeEvent(e,"keydown",n),Util.removeEvent(e,"keyup",i),Util.removeEvent(e,"keypress",r),Util.removeEvent(window,"blur",o),o()},s.sync=function(e){l.syncModifiers(e)},s}function Mouse(e){"use strict";function t(){d.target.setCapture&&d.target.setCapture(),f=!0}function n(){d.target.releaseCapture&&d.target.releaseCapture(),f=!1}function r(){h=null}function i(e,t){var n,i,o;if(!d.focused)return!0;if(d.notify&&d.notify(e),n=e?e:window.event,i=Util.getEventPosition(e,d.target,d.scale),e.touches||e.changedTouches){if(1==t){if(null==h)p=i;else{clearTimeout(h);var s=p.x-i.x,a=p.y-i.y,l=Math.sqrt(s*s+a*a);l<20*window.devicePixelRatio&&(i=p)}h=setTimeout(r,500)}o=d.touchButton}else o=n.which?1<<n.button:(1&n.button)+2*(2&n.button)+(4&n.button)/2;return d.onMouseButton&&(Util.Debug("onMouseButton "+(t?"down":"up")+", x: "+i.x+", y: "+i.y+", bmask: "+o),d.onMouseButton(i.x,i.y,t,o)),Util.stopEvent(e),!1}function o(e){t(),i(e,1)}function s(e){f&&(i(e,0),n())}function a(e){var t,n,r,i;return d.focused?(d.notify&&d.notify(e),t=e?e:window.event,n=Util.getEventPosition(e,d.target,d.scale),i=t.detail?-1*t.detail:t.wheelDelta/40,r=i>0?8:16,d.onMouseButton&&(d.onMouseButton(n.x,n.y,1,r),d.onMouseButton(n.x,n.y,0,r)),Util.stopEvent(e),!1):!0}function l(e){var t,n;return d.focused?(d.notify&&d.notify(e),t=e?e:window.event,n=Util.getEventPosition(e,d.target,d.scale),d.onMouseMove&&d.onMouseMove(n.x,n.y),Util.stopEvent(e),!1):!0}function u(e){var t,n;return d.focused?(t=e?e:window.event,n=Util.getEventPosition(e,d.target,d.scale),n.realx>=0&&n.realy>=0&&n.realx<d.target.offsetWidth&&n.realy<d.target.offsetHeight?(Util.stopEvent(e),!1):!0):!0}var c={},d={},f=!1,h=null,p=null;return Util.conf_defaults(d,c,e,[["target","ro","dom",document,"DOM element that captures mouse input"],["notify","ro","func",null,"Function to call to notify whenever a mouse event is received"],["focused","rw","bool",!0,"Capture and send mouse clicks/movement"],["scale","rw","float",1,"Viewport scale factor 0.0 - 1.0"],["onMouseButton","rw","func",null,"Handler for mouse button click/release"],["onMouseMove","rw","func",null,"Handler for mouse movement"],["touchButton","rw","int",1,"Button mask (1, 2, 4) for touch devices (0 means ignore clicks)"]]),c.grab=function(){var e=d.target;"ontouchstart"in document.documentElement?(Util.addEvent(e,"touchstart",o),Util.addEvent(window,"touchend",s),Util.addEvent(e,"touchend",s),Util.addEvent(e,"touchmove",l)):(Util.addEvent(e,"mousedown",o),Util.addEvent(window,"mouseup",s),Util.addEvent(e,"mouseup",s),Util.addEvent(e,"mousemove",l),Util.addEvent(e,Util.Engine.gecko?"DOMMouseScroll":"mousewheel",a)),Util.addEvent(document,"click",u),Util.addEvent(document.body,"contextmenu",u)},c.ungrab=function(){var e=d.target;"ontouchstart"in document.documentElement?(Util.removeEvent(e,"touchstart",o),Util.removeEvent(window,"touchend",s),Util.removeEvent(e,"touchend",s),Util.removeEvent(e,"touchmove",l)):(Util.removeEvent(e,"mousedown",o),Util.removeEvent(window,"mouseup",s),Util.removeEvent(e,"mouseup",s),Util.removeEvent(e,"mousemove",l),Util.removeEvent(e,Util.Engine.gecko?"DOMMouseScroll":"mousewheel",a)),Util.removeEvent(document,"click",u),Util.removeEvent(document.body,"contextmenu",u)},c}